import React, { Children, Dispatch, MutableRefObject, SetStateAction, useEffect, useState } from "react";
import { Stage, Layer, Line } from "react-konva";
import useImage from 'use-image'
import { Image } from 'react-konva';
import { TouchEvent } from "react";
import styles from "../styles/draw.module.css"
import { useRecoilState,useRecoilValue } from "recoil";
import { toolState,sizeState,colorState,downloadState,modalState } from '../atoms/atoms';
import { forwardRef } from "react";
import Konva from "konva";


const Draw = ()=>{

 
  const tool = useRecoilValue(toolState);
  const size = useRecoilValue(sizeState);
  const [color, setColor] = useRecoilState(colorState);
  const [download,setDownload] = useRecoilState(downloadState)
  const [modal,setModal] = useRecoilState(modalState)
  const [lines, setLines] = useState<Array<any>>([]);
  const isDrawing = React.useRef(false);
  const stageRef = React.useRef<any>();
  const camera_image_path = "./iPhone/iPhone7/(PRODUCT)RED_camera.png"

  const [image] = useImage("./iPhone/iPhone7/(PRODUCT)RED.png")
  const [camera] = useImage(camera_image_path)
  console.log(camera_image_path);

  const json = 
  {"attrs":{"width":268,"height":539},
  "className":"Stage",
  "children":
    [{"attrs":{},"className":"Layer",
      "children":[{"attrs":{"width":269,"height":540},"className":"Image"}]},
      {"attrs":{},"className":"Layer",
      "children":
        [{"attrs":
          {"points":[46.48957824707031,96.13542556762695,47.15625,95.46875381469727,51.822906494140625,94.13542556762695,55.822906494140625,93.46875381469727,62.48957824707031,90.80208206176758,71.15625,86.80208206176758,74.48957824707031,85.46875381469727,80.48957824707031,82.80208206176758,87.15625,80.13542556762695,91.82290649414062,78.80208206176758,93.15625,78.13542556762695,95.15625,77.46875381469727,96.48957824707031,77.46875381469727],
          "stroke":"#000","strokeWidth":5,"tension":0.5,"lineCap":"round"},
          "className":"Line"}
        ,{"attrs":
          {"points":[67.82290649414062,206.13542556762695,67.82290649414062,205.46876907348633,67.82290649414062,204.13542556762695,67.82290649414062,200.13542556762695,69.15625,190.13542556762695,70.48957824707031,183.46876907348633,75.82290649414062,168.13542556762695,80.48957824707031,152.13542556762695,83.15625,143.46876907348633,89.82290649414062,126.13542556762695,95.82290649414062,110.13542556762695,102.48957824707031,94.80208206176758,105.82290649414062,88.13542556762695,113.15625,76.13542556762695,121.15625,66.80208206176758,129.15625,59.468753814697266,133.15625,56.80208206176758,141.15625,53.468753814697266,147.82290649414062,52.13542556762695,155.15625,52.80208206176758,161.82290649414062,55.468753814697266,165.15625,57.468753814697266,173.15625,61.468753814697266,179.82290649414062,67.46875381469727,186.48959350585938,74.13542556762695,189.82290649414062,77.46875381469727,195.15625,86.13542556762695,199.82290649414062,94.80208206176758,204.48959350585938,106.13542556762695,207.15625,111.46875381469727,211.15625,124.13542556762695,213.82290649414062,138.80208206176758,215.15625,154.80208206176758,215.15625,163.46876907348633,215.15625,181.46876907348633,215.15625,199.46876907348633,213.82290649414062,217.46876907348633,213.15625,226.13542556762695,211.15625,244.13542556762695,207.15625,262.13542556762695,202.48959350585938,278.8020820617676,200.48959350585938,286.8020820617676,195.82290649414062,301.4687690734863,189.82290649414062,313.4687690734863,184.48959350585938,323.4687690734863,180.48959350585938,328.8020820617676,173.82290649414062,338.13542556762695,167.15625,345.4687690734863,163.15625,348.13542556762695,156.48959350585938,353.4687690734863,148.48959350585938,357.4687690734863,140.48959350585938,359.4687690734863,131.82290649414062,360.13542556762695,127.82290649414062,360.13542556762695,119.82290649414062,359.4687690734863,110.48959350585938,357.4687690734863,102.48957824707031,354.13542556762695,98.48957824707031,352.13542556762695,89.82290649414062,347.4687690734863,83.15625,341.4687690734863,75.82290649414062,333.4687690734863,72.48957824707031,328.8020820617676,67.15625,319.4687690734863,63.15625,306.8020820617676,61.15625,293.4687690734863,60.48957824707031,286.13542556762695,60.48957824707031,270.13542556762695,61.822906494140625,253.46876907348633,63.822906494140625,238.13542556762695,69.15625,223.46876907348633,72.48957824707031,216.13542556762695,78.48957824707031,202.13542556762695,86.48957824707031,188.80208206176758,94.48957824707031,177.46876907348633,99.15625,172.13542556762695,108.48959350585938,164.13542556762695,118.48959350585938,157.46876907348633,123.82290649414062,155.46876907348633,133.15625,152.13542556762695,143.15625,152.13542556762695,153.15625,153.46876907348633,157.82290649414062,154.80208206176758,166.48959350585938,159.46876907348633,175.82290649414062,167.46876907348633,183.82290649414062,176.13542556762695,188.48959350585938,182.80208206176758,195.82290649414062,195.46876907348633,201.15625,209.46876907348633,205.82290649414062,224.80208206176758,209.82290649414062,240.80208206176758,210.48959350585938,248.80208206176758,211.15625,265.4687690734863,210.48959350585938,280.8020820617676,209.82290649414062,287.4687690734863,207.15625,301.4687690734863,202.48959350585938,316.13542556762695,197.82290649414062,331.4687690734863,191.15625,346.8020820617676,187.15625,354.13542556762695,179.15625,368.8020820617676,169.15625,382.8020820617676,159.82290649414062,394.1354560852051,153.82290649414062,398.8020820617676,143.15625,406.8020820617676,131.82290649414062,412.1354560852051,125.82290649414062,414.8020820617676,113.82290649414062,419.4687690734863,102.48957824707031,421.4687690734863,89.82290649414062,419.4687690734863,77.15625,414.8020820617676,71.82290649414062,412.1354560852051,60.48957824707031,404.1354560852051,50.48957824707031,394.1354560852051,41.15625,381.4687690734863,35.822906494140625,374.13542556762695,29.15625,357.4687690734863,22.489578247070312,339.4687690734863,17.15625,320.8020820617676,15.15625,310.8020820617676,13.15625,287.4687690734863,13.15625,262.8020820617676,13.822906494140625,240.13542556762695,13.822906494140625,229.46876907348633,16.489578247070312,207.46876907348633,19.822906494140625,185.46876907348633,25.15625,164.13542556762695,28.489578247070312,154.80208206176758,35.15625,136.13542556762695,43.15625,119.46875381469727,46.48957824707031,112.13542556762695,55.15625,98.80208206176758,63.15625,88.13542556762695,71.82290649414062,79.46875381469727,75.82290649414062,76.13542556762695,83.82290649414062,70.80208206176758,91.82290649414062,68.80208206176758,101.15625,68.13542556762695,109.82290649414062,70.13542556762695,115.15625,71.46875381469727,124.48959350585938,76.80208206176758,133.15625,85.46875381469727,137.82290649414062,91.46875381469727,145.82290649414062,107.46875381469727,152.48959350585938,126.80208206176758,158.48959350585938,152.13542556762695,162.48959350585938,182.13542556762695,164.48959350585938,198.13542556762695,167.15625,235.46876907348633,171.82290649414062,277.4687690734863,181.82290649414062,332.13542556762695,191.15625,362.13542556762695,213.15625,410.8020820617676],
          "stroke":"#000","strokeWidth":5,"tension":0.5,"lineCap":"round"},
          "className":"Line"},
          {"attrs":{"width":269,"height":540},"className":"Image"}]}]}
  
  // const json = {"attrs":{"width":268,"height":539},"className":"Stage","children":[{"attrs":{},"className":"Layer","children":[{"attrs":{"width":269,"height":540},"className":"Image"}]},{"attrs":{},"className":"Layer","children":[{"attrs":{"points":[54.48957824707031,123.46875381469727,55.822906494140625,123.46875381469727,57.822906494140625,122.13542556762695,62.48957824707031,119.46875381469727,69.15625,116.13542556762695,77.15625,110.80208206176758,85.15625,104.80208206176758,93.15625,99.46875381469727,100.48957824707031,93.46875381469727,107.15625,88.13542556762695,111.82290649414062,84.13542556762695,116.48959350585938,79.46875381469727,121.15625,74.13542556762695,124.48959350585938,70.80208206176758,126.48959350585938,68.13542556762695,127.82290649414062,66.13542556762695,129.15625,64.80208206176758],"stroke":"#000","strokeWidth":5,"tension":0.5,"lineCap":"round"},"className":"Line"},{"attrs":{"points":[92.48957824707031,69.46875381469727,92.48957824707031,70.13542556762695,92.48957824707031,70.80208206176758,92.48957824707031,72.13542556762695,92.48957824707031,75.46875381469727,92.48957824707031,80.13542556762695,92.48957824707031,86.80208206176758,92.48957824707031,93.46875381469727,91.82290649414062,101.46875381469727,91.82290649414062,109.46875381469727,91.15625,116.80208206176758,90.48957824707031,123.46875381469727,90.48957824707031,130.13542556762695,91.15625,136.13542556762695,92.48957824707031,141.46876907348633,93.15625,146.13542556762695,94.48957824707031,150.80208206176758,96.48957824707031,155.46876907348633,97.82290649414062,160.80208206176758,99.82290649414062,165.46876907348633,102.48957824707031,170.13542556762695,105.15625,174.80208206176758,107.82290649414062,178.80208206176758,109.82290649414062,182.80208206176758,111.15625,185.46876907348633,113.15625,188.13542556762695,114.48959350585938,190.13542556762695,115.15625,191.46876907348633,116.48959350585938,192.80208206176758,117.82290649414062,194.13542556762695,118.48959350585938,194.80208206176758],"stroke":"#000","strokeWidth":5,"tension":0.5,"lineCap":"round"},"className":"Line"},{"attrs":{"points":[158.48959350585938,82.80208206176758,158.48959350585938,83.46875381469727,158.48959350585938,84.13542556762695,158.48959350585938,84.80208206176758,158.48959350585938,85.46875381469727,158.48959350585938,86.13542556762695,157.82290649414062,86.80208206176758,157.82290649414062,88.13542556762695,157.15625,88.80208206176758,157.15625,90.13542556762695,156.48959350585938,91.46875381469727,155.82290649414062,93.46875381469727,154.48959350585938,95.46875381469727,153.15625,99.46875381469727,151.82290649414062,102.80208206176758,150.48959350585938,106.80208206176758,148.48959350585938,110.13542556762695,146.48959350585938,114.13542556762695,144.48959350585938,118.13542556762695,141.82290649414062,122.13542556762695,139.82290649414062,125.46875381469727,137.82290649414062,129.46876907348633,135.82290649414062,133.46876907348633,133.15625,137.46876907348633,131.15625,140.80208206176758,129.15625,144.13542556762695,125.82290649414062,148.13542556762695,123.82290649414062,152.13542556762695,121.15625,155.46876907348633,119.15625,158.13542556762695,117.15625,161.46876907348633,115.15625,164.80208206176758,111.82290649414062,168.80208206176758,109.15625,172.80208206176758,106.48959350585938,176.13542556762695,104.48957824707031,180.13542556762695,101.82290649414062,184.13542556762695,99.82290649414062,187.46876907348633,97.82290649414062,190.80208206176758,95.15625,194.13542556762695,93.15625,196.80208206176758,91.82290649414062,199.46876907348633,89.82290649414062,202.13542556762695,88.48957824707031,204.13542556762695,87.82290649414062,206.13542556762695,86.48957824707031,206.80208206176758,85.82290649414062,208.13542556762695,85.15625,208.80208206176758,84.48957824707031,209.46876907348633,83.82290649414062,210.13542556762695,83.15625,210.80208206176758,82.48957824707031,210.80208206176758,81.82290649414062,210.80208206176758,81.15625,210.80208206176758,80.48957824707031,210.80208206176758,79.15625,210.80208206176758,78.48957824707031,210.80208206176758,77.82290649414062,210.13542556762695,77.15625,210.13542556762695,76.48957824707031,208.80208206176758,75.15625,208.13542556762695,73.82290649414062,206.80208206176758,73.15625,204.80208206176758,71.82290649414062,202.80208206176758,71.15625,201.46876907348633,70.48957824707031,199.46876907348633,70.48957824707031,196.80208206176758,69.82290649414062,194.13542556762695,69.15625,191.46876907348633,69.15625,188.13542556762695,69.15625,186.13542556762695,69.82290649414062,184.13542556762695,70.48957824707031,180.80208206176758,71.15625,177.46876907348633,72.48957824707031,174.13542556762695,73.82290649414062,171.46876907348633,75.82290649414062,168.80208206176758,77.15625,165.46876907348633,79.15625,162.13542556762695,82.48957824707031,158.13542556762695,85.15625,154.13542556762695,89.15625,150.13542556762695,92.48957824707031,146.13542556762695,96.48957824707031,141.46876907348633,99.82290649414062,137.46876907348633,103.82290649414062,133.46876907348633,107.82290649414062,129.46876907348633,111.15625,125.46875381469727,115.15625,122.13542556762695,119.15625,118.13542556762695,123.82290649414062,115.46875381469727,127.15625,112.13542556762695,131.82290649414062,109.46875381469727,136.48959350585938,106.80208206176758,140.48959350585938,104.13542556762695,143.82290649414062,102.13542556762695,146.48959350585938,100.80208206176758,149.82290649414062,99.46875381469727,153.15625,98.80208206176758,156.48959350585938,98.13542556762695,158.48959350585938,97.46875381469727,161.15625,97.46875381469727,163.15625,97.46875381469727,165.82290649414062,97.46875381469727,168.48959350585938,98.13542556762695,171.15625,98.80208206176758,173.82290649414062,99.46875381469727,175.82290649414062,100.13542556762695,177.82290649414062,101.46875381469727,179.82290649414062,102.80208206176758,181.82290649414062,104.80208206176758,184.48959350585938,106.80208206176758,186.48959350585938,108.80208206176758,189.15625,110.80208206176758,191.82290649414062,113.46875381469727,194.48959350585938,116.13542556762695,196.48959350585938,119.46875381469727,198.48959350585938,122.80208206176758,200.48959350585938,126.80208206176758,202.48959350585938,130.80208206176758,204.48959350585938,134.80208206176758,205.82290649414062,138.80208206176758,206.48959350585938,142.80208206176758,207.15625,147.46876907348633,207.82290649414062,151.46876907348633,207.82290649414062,155.46876907348633,207.82290649414062,158.13542556762695,207.82290649414062,160.80208206176758,207.15625,163.46876907348633,206.48959350585938,166.80208206176758,205.82290649414062,168.80208206176758,205.15625,171.46876907348633,203.82290649414062,172.80208206176758,202.48959350585938,175.46876907348633,201.15625,177.46876907348633,197.15625,180.13542556762695,193.15625,184.13542556762695,189.15625,187.46876907348633,184.48959350585938,190.80208206176758,179.15625,193.46876907348633,175.15625,196.13542556762695,171.15625,198.80208206176758,167.82290649414062,200.13542556762695,163.82290649414062,201.46876907348633,161.82290649414062,202.80208206176758,159.82290649414062,202.80208206176758,159.15625,202.80208206176758],"stroke":"#000","strokeWidth":5,"tension":0.5,"lineCap":"round"},"className":"Line"},{"attrs":{"width":269,"height":540},"className":"Image"}]}]}
          console.log(json.children);
  
  return (
    <>
      <div>
        
      </div>
        <div >
        <div className={styles.view_box}>
          <Stage
            width={json.attrs.width}
            height={json.attrs.height}
            ref={stageRef}
          >
            <Layer>
                <Image  image={image}  width={json.children[0].children[0].attrs.width} height={json.children[0].children[0].attrs.height} />
            </Layer>
            <Layer>
              {json.children[1].children.map((value, i) => (
                <Line
                  key={i}
                  points={value.attrs.points}
                  stroke={value.attrs.stroke}
                  strokeWidth={value.attrs.strokeWidth}
                  tension={value.attrs.tension}
                  lineCap={`round`}
                  
                />
              ))}
              <Image image={camera} width={269} height={540}/>

            </Layer>
          </Stage>
        </div>
      </div>
    </>
  );
};
  export default Draw